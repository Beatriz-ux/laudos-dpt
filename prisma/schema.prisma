// Schema completo do Sistema de Laudos Policiais
// Baseado na documentação do laudo-backend

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("POSTGRES_PRISMA_URL")
}

// ============================================
// ENUMS
// ============================================

enum AppRole {
  AGENT
  OFFICER
}

enum Department {
  TRAFFIC
  CRIMINAL
  ADMINISTRATIVE
}

enum ReportStatus {
  PENDING       // Aguardando atribuição
  RECEIVED      // Atribuído a um policial
  IN_PROGRESS   // Policial iniciou trabalho
  COMPLETED     // Laudo finalizado
  CANCELLED     // Laudo cancelado
}

enum Priority {
  HIGH
  MEDIUM
  LOW
}

// ============================================
// MODELS
// ============================================

model Profile {
  id                   String    @id @default(cuid())
  username             String    @unique
  email                String    @unique
  password             String    // Senha criptografada
  name                 String
  department           Department
  badge                String    @unique // Matrícula/Placa
  isActive             Boolean   @default(true) @map("is_active")
  mustChangePassword   Boolean   @default(true) @map("must_change_password")
  lastLogin            DateTime? @map("last_login")
  createdAt            DateTime  @default(now()) @map("created_at")
  updatedAt            DateTime  @updatedAt @map("updated_at")

  // Relacionamentos
  roles                UserRole[]
  createdReports       Report[]          @relation("ReportCreator")
  assignedReports      Report[]          @relation("ReportAssignee")
  auditLogs            ReportAuditLog[]

  @@map("profiles")
}

model UserRole {
  id     String  @id @default(cuid())
  userId String  @map("user_id")
  role   AppRole

  // Relacionamentos
  user Profile @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, role])
  @@map("user_roles")
}

model Report {
  id                        String        @id @default(cuid())
  number                    String        @unique // Formato: YYYYMMDD-DEPT-0001
  status                    ReportStatus  @default(PENDING)
  priority                  Priority
  createdBy                 String        @map("created_by")
  assignedTo                String?       @map("assigned_to")
  assignedAt                DateTime?     @map("assigned_at")
  deadline                  DateTime?     @map("deadline") // Prazo para concluir

  // Campos preenchidos pelo Agente
  oficio                    String?       @map("oficio")
  orgaoRequisitante         String?       @map("orgao_requisitante")
  autoridadeRequisitante    String?       @map("autoridade_requisitante")
  guiaOficio                String?       @map("guia_oficio")
  dataGuiaOficio            DateTime?     @map("data_guia_oficio")
  ocorrenciaPolicial        String?       @map("ocorrencia_policial")
  objetivoPericia           String?       @map("objetivo_pericia") @db.Text
  preambulo                 String?       @map("preambulo") @db.Text
  historico                 String?       @map("historico") @db.Text
  placaPortada              String?       @map("placa_portada")
  vehicleSpecies            String?       @map("vehicle_species")
  vehicleType               String?       @map("vehicle_type")
  vidro                     String?       @map("vidro")
  outrasNumeracoes          String?       @map("outras_numeracoes") @db.Text

  // Localização
  locationAddress           String?       @map("location_address")
  locationCity              String?       @map("location_city")
  locationState             String?       @map("location_state")
  locationCoordinates       String?       @map("location_coordinates") // JSON string

  // Dados do veículo (preenchido por ambos)
  vehiclePlate              String?       @map("vehicle_plate")
  vehicleChassi             String?       @map("vehicle_chassi")
  vehicleVin                String?       @map("vehicle_vin")
  vehicleMotor              String?       @map("vehicle_motor")
  vehicleSerieMotor         String?       @map("vehicle_serie_motor")
  vehicleColor              String?       @map("vehicle_color")
  vehicleBrand              String?       @map("vehicle_brand")
  vehicleModel              String?       @map("vehicle_model")
  vehicleYear               Int?          @map("vehicle_year")
  vehicleCategory           String?       @map("vehicle_category")
  vehicleIsCloned           Boolean?      @default(false) @map("vehicle_is_cloned")
  vehicleIsAdulterated      Boolean?      @default(false) @map("vehicle_is_adulterated")
  vehicleLicensedTo         String?       @map("vehicle_licensed_to")
  vehicleTechnicalCondition String?       @map("vehicle_technical_condition") @db.Text

  // Informações adicionais do policial
  glassInfo                 String?       @map("glass_info") @db.Text
  plateInfo                 String?       @map("plate_info") @db.Text
  motorInfo                 String?       @map("motor_info") @db.Text
  centralEletronicaInfo     String?       @map("central_eletronica_info") @db.Text
  seriesAuxiliares          String?       @map("series_auxiliares") @db.Text

  // Dados originais (quando veículo for adulterado)
  originalPlate             String?       @map("original_plate")
  originalBrand             String?       @map("original_brand")
  originalModel             String?       @map("original_model")
  originalSpecies           String?       @map("original_species")
  originalType              String?       @map("original_type")
  originalColor             String?       @map("original_color")
  originalChassi            String?       @map("original_chassi")
  originalMotor             String?       @map("original_motor")
  originalLicensedTo        String?       @map("original_licensed_to")
  originalAnalysisDetails   String?       @map("original_analysis_details") @db.Text

  // Análise e Conclusão
  analysisIsConclusive      Boolean?      @map("analysis_is_conclusive")
  analysisConclusion        String?       @map("analysis_conclusion") @db.Text
  analysisJustification     String?       @map("analysis_justification") @db.Text
  analysisObservations      String?       @map("analysis_observations") @db.Text
  expertSignature           String?       @map("expert_signature") @db.Text // Base64 da assinatura

  // Metadados
  createdAt                 DateTime      @default(now()) @map("created_at")
  updatedAt                 DateTime      @updatedAt @map("updated_at")

  // Relacionamentos
  creator    Profile            @relation("ReportCreator", fields: [createdBy], references: [id])
  assignee   Profile?           @relation("ReportAssignee", fields: [assignedTo], references: [id])
  auditLogs  ReportAuditLog[]
  photos     VehiclePhoto[]

  @@map("reports")
}

model ReportAuditLog {
  id        String   @id @default(cuid())
  reportId  String   @map("report_id")
  action    String   // CREATED, UPDATED, ASSIGNED, CANCELLED
  userId    String   @map("user_id")
  userName  String   @map("user_name") // Desnormalizado propositalmente
  details   String?  @db.Text
  timestamp DateTime @default(now())

  // Relacionamentos
  report Report  @relation(fields: [reportId], references: [id], onDelete: Cascade)
  user   Profile @relation(fields: [userId], references: [id])

  @@map("report_audit_log")
}

model VehiclePhoto {
  id        String   @id @default(cuid())
  reportId  String   @map("report_id")
  category  String   // vehicle, plate, glass, chassi, motor, tag, year_plate, central, auxiliary, evidence
  subtype   String?  // Para evidências: chassi_adulterated, motor_adulterated, glass_adulterated, etc.
  photoData String   @map("photo_data") @db.Text // Base64 da imagem
  description String? @db.Text // Descrição opcional da foto
  createdAt DateTime @default(now()) @map("created_at")

  // Relacionamentos
  report Report @relation(fields: [reportId], references: [id], onDelete: Cascade)

  @@map("vehicle_photos")
}
